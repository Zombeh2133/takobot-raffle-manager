<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Master Raffle Tracker</title>
  <script src="/static/api.js?v=20250131"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  
  <!-- Dark Mode System -->
  <link rel="stylesheet" href="/static/dark-mode.css" />
  <script src="/static/dark-mode.js"></script>

  <style>
    :root {
      --app-width: 100vw;
      --app-height: 100vh;
      --sidebar-width: 252px;
      --content-left: 276px;
      --content-width: calc(100vw - 276px - 20px);
    }

    body{
      background-color:#FAF8F6;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      margin:0;
      font-family:'Inter',sans-serif;
      overflow: hidden;
    }

    /* Scale down for smaller screens */
    @media (max-width: 1600px), (max-height: 1020px) {
      .container {
        transform-origin: center center;
        transform: scale(calc(min(100vw / 1600, 100vh / 1020)));
      }
    }

    .container {
      width: 1600px;
      height: 1020px;
      background: #FAF8F6;
      position: relative;
    }

    /* MAIN CONTENT */
    .main-content {
      position: absolute;
      top: 60px;
      left: 40px;
      width: 1520px;
      height: 900px;
      overflow-y: auto;
      padding: 0 20px 20px 0;
    }

    .page-header {
      margin-bottom: 28px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-subtitle {
      font-size: 14px;
      color: #64748b;
      margin: 0;
    }

    /* ‚úÖ ADMIN PAGE NAVIGATION */
    .admin-page-nav {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      margin-bottom: 0;
      align-items: center;
    }

    .admin-page-btn {
      padding: 10px 20px;
      background: #ffffff;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .admin-page-btn:hover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.05);
      color: #8b5cf6;
      transform: translateY(-1px);
    }

    .admin-page-btn.active {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border-color: #8b5cf6;
      color: white;
    }

    .admin-page-btn.active:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    /* STATS CARDS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--card-color), var(--card-color-light));
    }

    .stat-card.purple { --card-color: #A855F7; --card-color-light: #D8B4FE; }
    .stat-card.blue { --card-color: #3B82F6; --card-color-light: #93C5FD; }
    .stat-card.green { --card-color: #10B981; --card-color-light: #6EE7B7; }
    .stat-card.red { --card-color: #EF4444; --card-color-light: #FCA5A5; }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .stat-label {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-size: 20px;
      background: var(--card-color);
      opacity: 0.1;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      line-height: 1;
      margin-bottom: 8px;
    }

    .stat-change {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
    }

    /* TABLE CARD */
    .table-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .refresh-btn {
      background: #ffffff;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-btn:hover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.05);
      color: #8b5cf6;
      transform: translateY(-1px);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #f1f5f9;
      background: #f9fafb;
    }

    .data-table tbody td {
      padding: 14px 16px;
      font-size: 14px;
      color: #111827;
      border-bottom: 1px solid #f1f5f9;
    }

    .data-table tbody tr:hover {
      background: #f9fafb;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }

    .badge.success {
      background: #D1FAE5;
      color: #065F46;
    }

    .badge.danger {
      background: #FEE2E2;
      color: #991B1B;
    }

    .badge.active {
      background: #DBEAFE;
      color: #1E40AF;
    }

    .badge.warning {
      background: #FEF3C7;
      color: #92400E;
    }

    /* DELETE BUTTON */
    .delete-raffle-btn {
      background: #FEE2E2;
      border: 1px solid #FCA5A5;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      color: #991B1B;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }

    .delete-raffle-btn:hover {
      background: #FCA5A5;
      color: #7F1D1D;
      transform: translateY(-1px);
    }

    .delete-raffle-btn:active {
      transform: translateY(0);
    }

    .delete-raffle-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* WINNER SELECTION MODAL */
    .winner-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .winner-modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .winner-modal-header {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .winner-modal-subtitle {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 24px;
    }

    .winner-search {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      margin-bottom: 16px;
      transition: border-color 0.2s ease;
    }

    .winner-search:focus {
      outline: none;
      border-color: #8b5cf6;
    }

    .participant-list {
      max-height: 300px;
      overflow-y: auto;
      border: 2px solid #f1f5f9;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .participant-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .participant-item:last-child {
      border-bottom: none;
    }

    .participant-item:hover {
      background: #f9fafb;
    }

    .participant-item.selected {
      background: #ede9fe;
      border-left: 4px solid #8b5cf6;
    }

    .participant-name {
      font-weight: 600;
      color: #111827;
    }

    .participant-spots {
      font-size: 12px;
      color: #64748b;
      background: #f1f5f9;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .winner-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .winner-modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .winner-modal-btn.cancel {
      background: #f1f5f9;
      color: #64748b;
    }

    .winner-modal-btn.cancel:hover {
      background: #e5e7eb;
    }

    .winner-modal-btn.cancel-raffle {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      color: white;
    }

    .winner-modal-btn.cancel-raffle:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .winner-modal-btn.confirm {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
    }

    .winner-modal-btn.confirm:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .winner-modal-btn.confirm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .no-participants-msg {
      padding: 32px;
      text-align: center;
      color: #64748b;
      font-size: 14px;
    }

    /* CANCEL CONFIRMATION MODAL */
    .cancel-confirm-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease;
    }

    .cancel-confirm-content {
      background: white;
      border-radius: 24px;
      padding: 0;
      width: 480px;
      max-width: 90vw;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
      overflow: hidden;
    }

    .cancel-confirm-header {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      padding: 32px;
      text-align: center;
      position: relative;
    }

    .cancel-confirm-icon {
      width: 72px;
      height: 72px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 36px;
      animation: shake 0.5s ease;
    }

    .cancel-confirm-title {
      font-size: 26px;
      font-weight: 800;
      color: white;
      margin: 0 0 8px 0;
      letter-spacing: -0.5px;
    }

    .cancel-confirm-subtitle {
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
      margin: 0;
    }

    .cancel-confirm-body {
      padding: 32px;
    }

    .cancel-confirm-message {
      font-size: 16px;
      font-weight: 500;
      color: #374151;
      line-height: 1.6;
      margin: 0 0 8px 0;
      text-align: center;
    }

    .cancel-confirm-raffle-id {
      font-size: 14px;
      font-weight: 700;
      color: #EF4444;
      text-align: center;
      padding: 12px;
      background: #FEE2E2;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .cancel-confirm-warning {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #FEF3C7;
      border-left: 4px solid #F59E0B;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .cancel-confirm-warning-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .cancel-confirm-warning-text {
      font-size: 13px;
      color: #92400E;
      line-height: 1.5;
      margin: 0;
    }

    .cancel-confirm-actions {
      display: flex;
      gap: 12px;
    }

    .cancel-confirm-btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cancel-confirm-btn-cancel {
      background: #f1f5f9;
      color: #64748b;
    }

    .cancel-confirm-btn-cancel:hover {
      background: #e5e7eb;
      transform: translateY(-2px);
    }

    .cancel-confirm-btn-confirm {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      color: white;
    }

    .cancel-confirm-btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    .cancel-confirm-btn:active {
      transform: translateY(0);
    }

    .cancel-confirm-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* FINISH RAFFLE BUTTON */
    .finish-raffle-btn {
      background: #D1FAE5;
      border: 1px solid #6EE7B7;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      color: #065F46;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      margin-right: 6px;
    }

    .finish-raffle-btn:hover {
      background: #6EE7B7;
      color: #064E3B;
      transform: translateY(-1px);
    }

    .finish-raffle-btn:active {
      transform: translateY(0);
    }

    .finish-raffle-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* REDDIT LINK STYLING */
    .reddit-link {
      color: #6E5FFC;
      text-decoration: none;
      font-size: 12px;
      max-width: 200px;
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .reddit-link:hover {
      text-decoration: underline;
      color: #5648CC;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
    }

    /* ACCESS DENIED MODAL */
    .access-denied-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 999999;
      animation: fadeIn 0.2s ease;
    }

    .access-denied-overlay.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .access-denied-modal {
      background: white;
      border-radius: 24px;
      padding: 0;
      width: 440px;
      max-width: 90vw;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
      overflow: hidden;
    }

    .access-modal-header {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
      padding: 32px;
      text-align: center;
      position: relative;
    }

    .access-modal-icon {
      width: 72px;
      height: 72px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 36px;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
    }

    .access-modal-title {
      font-size: 26px;
      font-weight: 800;
      color: white;
      margin: 0 0 8px 0;
      letter-spacing: -0.5px;
    }

    .access-modal-subtitle {
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
      margin: 0;
    }

    .access-modal-body {
      padding: 32px;
      text-align: center;
    }

    .access-modal-message {
      font-size: 16px;
      font-weight: 500;
      color: #374151;
      line-height: 1.6;
      margin: 0 0 24px 0;
    }

    .access-modal-actions {
      display: flex;
      gap: 12px;
    }

    .access-modal-btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
    }

    .access-modal-btn-primary {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
      color: white;
    }

    .access-modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    .access-modal-btn-primary:active {
      transform: translateY(0);
    }
  </style>
</head>

<body>
<div class="container">
    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="page-header">
        <h1 class="page-title">
          <span>üóÇÔ∏è</span>
          Master Raffle Tracker
        </h1>
        <p class="page-subtitle">All raffles in the database (Active + History)</p>
        
        <!-- ‚úÖ ADMIN PAGE NAVIGATION -->
        <div class="admin-page-nav">
          <button class="admin-page-btn" onclick="window.location.href='/admin'">
            üìä Analytics
          </button>
          <button class="admin-page-btn" onclick="window.location.href='/raffle-monitor'">
            üì° Raffle Monitor
          </button>
          <button class="admin-page-btn" onclick="window.location.href='/user-management'">
            üë• User Management
          </button>
          <button class="admin-page-btn active" onclick="window.location.href='/master-tracker'">
            üóÇÔ∏è Master Tracker
          </button>
        </div>
      </div>

      <!-- STATS CARDS -->
      <div class="stats-grid">
        <div class="stat-card purple">
          <div class="stat-header">
            <div class="stat-label">Total Raffles</div>
            <div class="stat-icon">üìä</div>
          </div>
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-change" id="totalSubtext">Loading...</div>
        </div>

        <div class="stat-card blue">
          <div class="stat-header">
            <div class="stat-label">Active Raffles</div>
            <div class="stat-icon">üîµ</div>
          </div>
          <div class="stat-value" id="statActive">0</div>
          <div class="stat-change">Currently running</div>
        </div>

        <div class="stat-card green">
          <div class="stat-header">
            <div class="stat-label">Completed</div>
            <div class="stat-icon">‚úÖ</div>
          </div>
          <div class="stat-value" id="statCompleted">0</div>
          <div class="stat-change">Finished raffles</div>
        </div>

        <div class="stat-card red">
          <div class="stat-header">
            <div class="stat-label">Cancelled</div>
            <div class="stat-icon">‚ùå</div>
          </div>
          <div class="stat-value" id="statCancelled">0</div>
          <div class="stat-change">Aborted raffles</div>
        </div>
      </div>

      <!-- RAFFLE TABLE -->
      <div class="table-card">
        <div class="table-header">
          <div>
            <h3 style="font-size: 18px; font-weight: 700; color: #111827; margin: 0 0 6px 0;">All Raffles</h3>
            <p style="font-size: 13px; color: #64748b; margin: 0;">Complete database of active and historical raffles</p>
          </div>
          <button class="refresh-btn" onclick="loadAllRaffles()">
            üîÑ Refresh
          </button>
        </div>
        
        <div id="allRafflesLoadingState" style="text-align: center; padding: 40px; display: none;">
          <div style="font-size: 32px; margin-bottom: 12px;">‚è≥</div>
          <div style="color: #64748b; font-size: 14px;">Loading all raffles...</div>
        </div>

        <div id="allRafflesEmptyState" class="empty-state" style="display: none;">
          <div class="empty-icon">üì≠</div>
          <div class="empty-title">No Raffles Found</div>
          <div class="empty-text">There are no raffles in the database yet.</div>
        </div>

        <table class="data-table" id="allRafflesTable" style="display: none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Host</th>
              <th>Status</th>
              <th>Reddit Link</th>
              <th>Date</th>
              <th>Spots</th>
              <th>Revenue</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="allRafflesTableBody">
            <!-- Populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Sidebar Admin Control - Shows popup for non-admin users (non-blocking)
      (async function initAdminControl() {
        try {
          const response = await fetch('/api/auth/current-user');
          
          if (!response.ok) {
            console.warn('Failed to check user status');
            return;
          }
          
          const data = await response.json();
          const isAdmin = data.data?.isAdmin === true;
          
          if (!isAdmin) {
            // Show access denied modal for non-admin users
            showAccessDenied();
            console.log('‚ùå Non-admin user - access denied');
          } else {
            console.log('‚úÖ Admin user - full access granted');
          }
        } catch (error) {
          console.error('Error checking admin status:', error);
        }
      })();

      // Function to show access denied modal
      function showAccessDenied() {
        const overlay = document.querySelector('.access-denied-overlay');
        if (overlay) {
          overlay.classList.add('show');
        }
      }
    </script>
</div>

<!-- MASTER RAFFLE TRACKER SCRIPT -->
<script>
  // ============ MASTER RAFFLE TRACKER ============
  async function loadAllRaffles() {
    const loadingState = document.getElementById('allRafflesLoadingState');
    const emptyState = document.getElementById('allRafflesEmptyState');
    const table = document.getElementById('allRafflesTable');
    const tbody = document.getElementById('allRafflesTableBody');

    // Show loading state
    loadingState.style.display = 'block';
    emptyState.style.display = 'none';
    table.style.display = 'none';

    try {
      const response = await fetch('/api/admin/all-raffles', {
        credentials: 'include'
      });

      const result = await response.json();

      if (!result.ok) {
        throw new Error(result.error || 'Failed to load raffles');
      }

      const raffles = result.raffles || [];
      const stats = result.stats || {};

      // Update stat cards
      document.getElementById('statTotal').textContent = stats.total || 0;
      document.getElementById('statActive').textContent = stats.totalActive || 0;
      document.getElementById('statCompleted').textContent = stats.totalCompleted || 0;
      document.getElementById('statCancelled').textContent = stats.totalCancelled || 0;
      document.getElementById('totalSubtext').textContent = `${stats.totalActive || 0} active + ${stats.totalHistory || 0} history`;

      // Hide loading
      loadingState.style.display = 'none';

      if (raffles.length === 0) {
        emptyState.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      // Populate table
      tbody.innerHTML = raffles.map(raffle => {
        // Format date
        const date = new Date(raffle.date);
        const formattedDate = date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        // Determine status badge class
        let statusClass = 'neutral';
        if (raffle.status === 'Active') statusClass = 'active';
        else if (raffle.status === 'completed' || raffle.status === 'Completed') statusClass = 'success';
        else if (raffle.status === 'cancelled' || raffle.status === 'Cancelled') statusClass = 'danger';

        // Truncate Reddit link
        let linkText = raffle.redditLink || 'N/A';
        if (linkText.length > 40) {
          linkText = linkText.substring(0, 37) + '...';
        }

        return `
          <tr>
            <td style="font-weight: 600; color: #6E5FFC;">#${raffle.id}</td>
            <td>${raffle.username}</td>
            <td><span class="badge ${statusClass}">${raffle.status}</span></td>
            <td>
              ${raffle.redditLink 
                ? `<a href="${raffle.redditLink}" target="_blank" class="reddit-link" title="${raffle.redditLink}">${linkText}</a>` 
                : '<span style="color: #94a3b8;">N/A</span>'}
            </td>
            <td style="font-size: 13px; color: #64748b;">${formattedDate}</td>
            <td>${raffle.filledSpots}/${raffle.totalSpots}</td>
            <td style="font-weight: 600; color: #10B981;">$${raffle.totalRevenue}</td>
            <td>
              ${raffle.status === 'Active' ? `
                <button 
                  class="finish-raffle-btn" 
                  onclick="finishRaffle(${raffle.id}, '${raffle.type}')"
                  data-raffle-id="${raffle.id}"
                  data-raffle-type="${raffle.type}"
                >
                  ‚úÖ Finish
                </button>
              ` : ''}
              <button 
                class="delete-raffle-btn" 
                onclick="deleteRaffle(${raffle.id}, '${raffle.type}')"
                data-raffle-id="${raffle.id}"
                data-raffle-type="${raffle.type}"
              >
                üóëÔ∏è Delete
              </button>
            </td>
          </tr>
        `;
      }).join('');

      // Show table
      emptyState.style.display = 'none';
      table.style.display = 'table';

      console.log(`‚úÖ Loaded ${raffles.length} raffles (${stats.totalActive} active, ${stats.totalHistory} history)`);
    } catch (error) {
      console.error('Failed to load all raffles:', error);
      loadingState.style.display = 'none';
      emptyState.innerHTML = `
        <div class="empty-icon">‚ö†Ô∏è</div>
        <div class="empty-title">Failed to Load</div>
        <div class="empty-text">${error.message}</div>
      `;
      emptyState.style.display = 'block';
      table.style.display = 'none';
    }
  }

  async function deleteRaffle(id, type) {
    if (!confirm(`Are you sure you want to delete this ${type} raffle (ID: ${id})?\n\nThis action cannot be undone.`)) {
      return;
    }

    const btn = document.querySelector(`button[data-raffle-id="${id}"][data-raffle-type="${type}"]`);
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Deleting...';
    }

    try {
      const response = await fetch('/api/admin/delete-raffle', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ id, type })
      });

      const result = await response.json();

      if (!result.ok) {
        throw new Error(result.error || 'Failed to delete raffle');
      }

      console.log(`‚úÖ Successfully deleted ${type} raffle ID: ${id}`);
      
      // Reload the table
      await loadAllRaffles();
    } catch (error) {
      console.error('Failed to delete raffle:', error);
      alert(`Failed to delete raffle: ${error.message}`);
      
      // Re-enable button
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'üóëÔ∏è Delete';
      }
    }
  }

  async function finishRaffle(id, type) {
    // Only allow finishing active raffles
    if (type !== 'active') {
      alert('Can only finish active raffles');
      return;
    }

    try {
      // Fetch raffle data to get participants
      const response = await fetch('/api/admin/all-raffles', {
        credentials: 'include'
      });

      const result = await response.json();
      if (!result.ok) {
        throw new Error('Failed to load raffle data');
      }

      const raffle = result.raffles.find(r => r.id === id && r.type === type);
      if (!raffle) {
        throw new Error('Raffle not found');
      }

      // Open winner selection modal
      openWinnerModal(raffle);
    } catch (error) {
      console.error('Failed to open finish raffle:', error);
      alert(`Failed to open finish raffle: ${error.message}`);
    }
  }

  let selectedWinner = null;
  let currentRaffleId = null;
  let currentRaffleType = null;

  function openWinnerModal(raffle) {
    currentRaffleId = raffle.id;
    currentRaffleType = raffle.type;
    selectedWinner = null;

    const modal = document.getElementById('winnerModal');
    const participantList = document.getElementById('participantList');
    const searchInput = document.getElementById('winnerSearch');
    const confirmBtn = document.getElementById('confirmFinishBtn');

    // Reset search
    searchInput.value = '';
    
    // Disable confirm button initially
    confirmBtn.disabled = true;

    // Populate participants - combine spots by username
    const participants = raffle.participants || [];
    
    if (participants.length === 0) {
      participantList.innerHTML = '<div class="no-participants-msg">No participants in this raffle</div>';
    } else {
      // Group participants by username and sum their spots
      const combinedParticipants = {};
      
      participants.forEach(p => {
        const name = (p.redditUser || p.username || 'Unknown').trim();
        const spots = p.spots || p.spotsRequested || 0;
        
        if (combinedParticipants[name]) {
          combinedParticipants[name].spots += spots;
        } else {
          combinedParticipants[name] = {
            username: name,
            spots: spots
          };
        }
      });
      
      // Convert to array
      const participantArray = Object.values(combinedParticipants);
      
      // Store for search functionality
      if (window.storeCurrentParticipants) {
        window.storeCurrentParticipants(participantArray);
      }
      
      renderParticipants(participantArray);
    }

    // Show modal
    modal.style.display = 'flex';
  }

  function renderParticipants(participants, filter = '') {
    const participantList = document.getElementById('participantList');
    
    const filtered = filter 
      ? participants.filter(p => {
          const name = (p.username || '').toLowerCase();
          return name.includes(filter.toLowerCase());
        })
      : participants;

    if (filtered.length === 0) {
      participantList.innerHTML = '<div class="no-participants-msg">No matching participants</div>';
      return;
    }

    // Sort by spots (descending) then by username
    filtered.sort((a, b) => {
      if (b.spots !== a.spots) {
        return b.spots - a.spots;
      }
      return a.username.localeCompare(b.username);
    });

    participantList.innerHTML = filtered.map((p, index) => {
      const name = p.username || 'Unknown';
      const spots = p.spots || 0;
      return `
        <div class="participant-item" onclick="selectWinner('${name.replace(/'/g, "\\'")}', ${spots}, this)">
          <div class="participant-name">${name}</div>
          <div class="participant-spots">${spots} spot${spots !== 1 ? 's' : ''}</div>
        </div>
      `;
    }).join('');
  }

  function selectWinner(username, spots, element) {
    // Remove previous selection
    document.querySelectorAll('.participant-item').forEach(item => {
      item.classList.remove('selected');
    });

    // Select this item
    element.classList.add('selected');
    
    selectedWinner = {
      username: username,
      spots: spots
    };

    // Enable confirm button
    document.getElementById('confirmFinishBtn').disabled = false;
  }

  function closeWinnerModal() {
    document.getElementById('winnerModal').style.display = 'none';
    selectedWinner = null;
    currentRaffleId = null;
    currentRaffleType = null;
  }

  async function confirmFinishRaffle() {
    if (!selectedWinner || !currentRaffleId || !currentRaffleType) {
      alert('Please select a winner');
      return;
    }

    const confirmBtn = document.getElementById('confirmFinishBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Finishing...';

    try {
      const response = await fetch('/api/admin/finish-raffle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ 
          id: currentRaffleId, 
          type: currentRaffleType,
          winner: selectedWinner
        })
      });

      const result = await response.json();

      if (!result.ok) {
        throw new Error(result.error || 'Failed to finish raffle');
      }

      console.log(`‚úÖ Successfully finished raffle ID: ${currentRaffleId} with winner: ${selectedWinner.username}`);
      
      // Close modal
      closeWinnerModal();
      
      // Reload the table
      await loadAllRaffles();
    } catch (error) {
      console.error('Failed to finish raffle:', error);
      alert(`Failed to finish raffle: ${error.message}`);
      
      // Re-enable button
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Finish Raffle';
    }
  }

  async function cancelRaffleFromModal() {
    if (!currentRaffleId || !currentRaffleType) {
      alert('Please select a raffle to cancel');
      return;
    }

    // Only allow cancelling active raffles
    if (currentRaffleType !== 'active') {
      alert('Can only cancel active raffles');
      return;
    }

    // Show the beautiful cancel confirmation modal
    openCancelConfirmModal(currentRaffleId);
    
    // Close the winner modal
    closeWinnerModal();
  }

  // Search functionality
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('winnerSearch');
    if (searchInput) {
      let currentParticipantArray = [];
      
      searchInput.addEventListener('input', (e) => {
        // Filter the current participant array
        renderParticipants(currentParticipantArray, e.target.value);
      });
      
      // Store participant array when modal opens
      window.storeCurrentParticipants = function(participants) {
        currentParticipantArray = participants;
      };
    }
  });

  // Auto-load all raffles when page loads
  document.addEventListener('DOMContentLoaded', () => {
    // Load immediately - no delay needed
    loadAllRaffles();
  });
</script>

<!-- WINNER SELECTION MODAL -->
<div class="winner-modal" id="winnerModal">
  <div class="winner-modal-content">
    <div class="winner-modal-header">Select a Winner</div>
    <div class="winner-modal-subtitle">Choose a participant to be the winner of this raffle</div>
    
    <input type="text" id="winnerSearch" class="winner-search" placeholder="Search participants..." />
    
    <div id="participantList" class="participant-list">
      <!-- Populated by JavaScript -->
    </div>
    
    <div class="winner-modal-actions">
      <button class="winner-modal-btn cancel" onclick="closeWinnerModal()">Cancel</button>
      <button class="winner-modal-btn cancel-raffle" onclick="cancelRaffleFromModal()">√ó Cancel Raffle</button>
      <button class="winner-modal-btn confirm" id="confirmFinishBtn" onclick="confirmFinishRaffle()">Finish Raffle</button>
    </div>
  </div>
</div>

<!-- CANCEL CONFIRMATION MODAL -->
<div class="cancel-confirm-modal" id="cancelConfirmModal">
  <div class="cancel-confirm-content">
    <div class="cancel-confirm-header">
      <div class="cancel-confirm-icon">‚ö†Ô∏è</div>
      <h2 class="cancel-confirm-title">Cancel Raffle?</h2>
      <p class="cancel-confirm-subtitle">This action cannot be undone</p>
    </div>
    <div class="cancel-confirm-body">
      <p class="cancel-confirm-message">
        Are you sure you want to cancel this raffle?
      </p>
      <div class="cancel-confirm-raffle-id" id="cancelRaffleIdDisplay">
        Raffle ID: #<span id="cancelRaffleIdText">0</span>
      </div>
      <div class="cancel-confirm-warning">
        <div class="cancel-confirm-warning-icon">üí°</div>
        <div class="cancel-confirm-warning-text">
          This will save the raffle to history with a "cancelled" status. All participant data will be preserved but the raffle will be marked as aborted.
        </div>
      </div>
      <div class="cancel-confirm-actions">
        <button class="cancel-confirm-btn cancel-confirm-btn-cancel" onclick="closeCancelConfirmModal()">
          Keep Raffle
        </button>
        <button class="cancel-confirm-btn cancel-confirm-btn-confirm" id="cancelConfirmBtn" onclick="executeCancelRaffle()">
          Yes, Cancel It
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== CANCEL CONFIRMATION MODAL =====
  function openCancelConfirmModal(raffleId) {
    const modal = document.getElementById('cancelConfirmModal');
    const raffleIdText = document.getElementById('cancelRaffleIdText');
    
    if (modal && raffleIdText) {
      raffleIdText.textContent = raffleId;
      modal.style.display = 'flex';
    }
  }

  function closeCancelConfirmModal() {
    const modal = document.getElementById('cancelConfirmModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  async function executeCancelRaffle() {
    const raffleIdText = document.getElementById('cancelRaffleIdText');
    if (!raffleIdText) return;
    
    const raffleId = parseInt(raffleIdText.textContent, 10);
    if (isNaN(raffleId)) return;
    
    const confirmBtn = document.getElementById('cancelConfirmBtn');
    if (confirmBtn) {
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Cancelling...';
    }
    
    try {
      const response = await fetch('/api/admin/cancel-raffle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ 
          id: raffleId, 
          type: 'active'
        })
      });

      const result = await response.json();

      if (!result.ok) {
        throw new Error(result.error || 'Failed to cancel raffle');
      }

      console.log(`‚úÖ Successfully cancelled raffle ID: ${raffleId}`);
      
      // Close modal
      closeCancelConfirmModal();
      
      // Reload the table
      await loadAllRaffles();
    } catch (error) {
      console.error('Failed to cancel raffle:', error);
      alert(`Failed to cancel raffle: ${error.message}`);
      
      // Re-enable button
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Yes, Cancel It';
      }
    }
  }
</script>

<!-- ACCESS DENIED MODAL -->
<div class="access-denied-overlay" id="accessDeniedOverlay" onclick="closeAccessDenied(event)">
  <div class="access-denied-modal" onclick="event.stopPropagation()">
    <div class="access-modal-header">
      <div class="access-modal-icon">üîí</div>
      <h2 class="access-modal-title">Access Denied</h2>
      <p class="access-modal-subtitle">Admin privileges required</p>
    </div>
    <div class="access-modal-body">
      <p class="access-modal-message">
        You don't have permission to access this page. This area is restricted to administrators only.
      </p>
      <div class="access-modal-actions">
        <button class="access-modal-btn access-modal-btn-primary" onclick="closeAccessDenied()">
          Got it
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== ACCESS DENIED MODAL =====
  function closeAccessDenied(event) {
    // Go back to previous page when closing
    window.location.href = '/dashboard';
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const overlay = document.getElementById('accessDeniedOverlay');
      if (overlay && overlay.classList.contains('show')) {
        closeAccessDenied({ target: overlay });
      }
    }
  });
</script>

</body>
</html>
