<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Active Raffle</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    /* ============================== MASTER LAYOUT VARIABLES ============================== */
    :root{
      --app-width: 1600px;
      --app-height: 1020px;
      --sidebar-width: 252px;
      --content-left: 360px;
      --content-width: 1120px;
    }

    body{
      background-color:#303149;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      margin:0;
      font-family:'Inter',sans-serif;
    }

    .white-square{
      width:var(--app-width);
      height:var(--app-height);
      background-color:#FAF8F6;
      position:relative;
      overflow:hidden;
      border-radius:30px;
      z-index: 5;
    }

    .top-sidebar{
      position:absolute; top:0; left:0;
      width:var(--sidebar-width); height:200px;
      background-image:url('/static/assets/Background/Top-Sidebar.png');
      background-size:cover; background-repeat:no-repeat;
      border-top-left-radius:30px;
      border-top-right-radius:30px;
      z-index:5;
    }

    .tako{
      position:absolute;
      top:60px; left:calc(var(--sidebar-width) / 2);
      transform:translate(-50%,-50%);
      width:148px; height:148px;
      background-image:url('/static/assets/Icons/TAKO%201.png');
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      z-index:25;
      pointer-events:none;
    }

    .sidebar{
      position:absolute;
      left:0; bottom:0px;
      width:var(--sidebar-width); height:900px;
      background-image:url('/static/assets/Background/Sidebar.png');
      background-size:cover;
      background-repeat:no-repeat;
      border-bottom-right-radius:30px;
      border-bottom-left-radius:30px;
      z-index:10;
    }

    .rectangle{
      position:absolute;
      top:135px; left:0;
      width:165px; height:48px;
      background-image:url('/static/assets/Background/Rectangle.png');
      background-size:cover;
      background-repeat:no-repeat;
      z-index:20;
      pointer-events:none;
    }

    .square{
      position:absolute;
      top:140px; left:30px;
      width:244px; height:52px;
      background-image:url('/static/assets/Background/Square.png');
      background-size:cover;
      background-repeat:no-repeat;
      background-position:center;
      z-index:30;
      pointer-events:none;
      transition:top 140ms ease;
    }

    .sidebar-nav{
      position:absolute;
      top:140px; left:55px;
      width:244px;
      font-size:16px;
      line-height:58px;
      z-index:40;
    }

    .sidebar-nav a{
      display:block;
      position:relative;
      padding-left:26px;
      color:#ffffff;
      text-decoration:none;
      font-weight:400;
      user-select:none;
      cursor:pointer;
    }

    .sidebar-nav a.is-active{
      color:#6E5FFC;
      font-weight:600;
    }

    .nav-icon{
      position:absolute;
      left:-5px; top:17px;
      width:20px; height:20px;
      filter:brightness(0) invert(1);
      pointer-events:none;
      z-index:41;
    }

    .sidebar-nav a.is-active .nav-icon{
      filter:brightness(0) saturate(100%) invert(46%) sepia(82%) saturate(2780%) hue-rotate(222deg);
    }

    /* SEARCH BAR */
    .search-bar {
      position: absolute;
      top: 40px;
      left: var(--content-left);
      width: calc(var(--content-width) - 400px);
      display: flex;
      align-items: center;
      gap: 10px;
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 16px;
      z-index: 50;
    }

    .search-bar img { width: 20px; height: 20px; }
    .search-bar input {
      border: none;
      outline: none;
      width: 100%;
      font-size: 14px;
      background: transparent;
    }

    /* TOP RIGHT ICONS */
    #themeToggle { position: absolute; top: 48px; right: 260px; width: 44px; height: 24px; cursor: pointer; }
    #settingsBtn { position: absolute; top: 48px; right: 200px; width: 24px; height: 24px; cursor: pointer; }
    #bellBtn     { position: absolute; top: 48px; right: 150px; width: 24px; height: 24px; cursor: pointer; }
    #profileBtn  { position: absolute; top: 48px; right: 100px; width: 24px; height: 24px; cursor: pointer; }

    /* STATS */
    .stats-row{
      position:absolute;
      top:110px;
      left:var(--content-left);
      width:var(--content-width);
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:18px;
      z-index:55;
    }

    .stat-card{
      border-radius:16px;
      padding:14px 18px;
      color:#fff;
      box-shadow:0 10px 18px rgba(0,0,0,0.12);
      min-height:78px;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    .stat-label{
      font-size:12px;
      letter-spacing:1px;
      font-weight:700;
      text-transform:uppercase;
      opacity:0.9;
      margin-bottom:6px;
    }

    .stat-value{
      font-size:30px;
      font-weight:700;
      line-height:1;
    }

    .c-pink{   background:#ff4fb2; }
    .c-purple{ background:#a855f7; }
    .c-green{  background:#00c26f; }
    .c-orange{ background:#f59e0b; }
    .c-blue{   background:#3b82f6; }

    /* PARTICIPANTS CARD */
    .participants-card{
      position:absolute;
      top:235px;
      left:var(--content-left);
      width:var(--content-width);
      height:calc(var(--app-height) - 235px - 40px);
      background:#ffffff;
      border-radius:18px;
      box-shadow:0 18px 30px rgba(0,0,0,0.10);
      overflow:hidden;
      z-index:52;
      display:flex;
      flex-direction:column;
    }

    .participants-header{
      padding:22px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
      border-bottom:1px solid #eef0f4;
      background:#ffffff;
    }

    .participants-title{
      margin:0;
      font-size:18px;
      font-weight:700;
      color:#111827;
    }

    .participants-sub{
      margin-top:6px;
      font-size:13px;
      color:#64748b;
      font-weight:500;
    }

    .table-wrap{
      flex:1;
      overflow:auto;
      background:#ffffff;
    }

    table.p-table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      table-layout:fixed;
    }

    .p-table col.col-reddit  { width:260px; }
    .p-table col.col-name    { width:170px; }
    .p-table col.col-comment { width:auto;  }
    .p-table col.col-spots   { width:90px;  }
    .p-table col.col-owed    { width:90px;  }
    .p-table col.col-status  { width:120px; }

    .p-table thead th{
      text-align:left;
      padding:14px 24px;
      font-size:11px;
      letter-spacing:0.8px;
      text-transform:uppercase;
      color:#334155;
      background:#ffffff;
      position:sticky;
      top:0;
      z-index:1;
      border-bottom:1px solid #eef0f4;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .p-table tbody td{
      padding:18px 24px;
      border-bottom:1px solid #eef0f4;
      vertical-align:middle;
      color:#0f172a;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .user-cell{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .avatar{
      width:34px;
      height:34px;
      border-radius:50%;
      display:grid;
      place-items:center;
      color:#fff;
      font-weight:700;
      background:linear-gradient(135deg,#a855f7,#ff4fb2);
      flex-shrink:0;
    }

    .reddit-link{
      color:#6E5FFC;
      text-decoration:none;
      font-weight:600;
    }

    .comment-muted{
      color:#334155;
      font-style:italic;
    }

    .spots-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:34px;
      height:26px;
      padding:0 10px;
      border-radius:999px;
      background:#efe9ff;
      color:#6E5FFC;
      font-weight:700;
      font-size:12px;
    }

    .status-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }

    .status-paid{ background:#dcfce7; color:#166534; }
    .status-pending{ background:#fef3c7; color:#92400e; }

    .dot{
      width:18px;
      height:18px;
      border-radius:50%;
      display:grid;
      place-items:center;
      font-size:12px;
      line-height:1;
      background:rgba(255,255,255,0.55);
    }

    .participants-foot{
      padding:14px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-top:1px solid #eef0f4;
      color:#475569;
      font-size:13px;
      background:#ffffff;
    }

    /* Resize handles */
    .th-inner{ position:relative; padding-right:14px; }
    .col-resizer{
      position:absolute;
      top:0;
      right:-8px;
      width:16px;
      height:100%;
      cursor:col-resize;
      user-select:none;
      touch-action:none;
    }
    .col-resizer::after{
      content:"";
      position:absolute;
      top:20%;
      left:50%;
      transform:translateX(-50%);
      width:2px;
      height:60%;
      background:rgba(15,23,42,0.12);
      border-radius:2px;
      opacity:0;
      transition:opacity 120ms ease;
    }
    th:hover .col-resizer::after{ opacity:1; }
    .resizing *{ cursor:col-resize !important; user-select:none !important; }

    /* Buttons */
    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      transition: all 150ms ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn-blue   { background: #3B82F6; }
    .btn-green  { background: #10B981; }
    .btn-purple { background: linear-gradient(90deg, #7C3AED, #EC4899); }
    .btn-red    { background: #EF4444; }

    .search-box input {
      height: 40px;
      padding: 0 14px;
      border-radius: 12px;
      border: 1px solid #E6E8F0;
      font-size: 14px;
    }

    .filter-select {
      height: 40px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid #E6E8F0;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
    }

    /* MODAL STYLES */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: opacity 200ms ease, visibility 200ms ease;
    }

    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 32px 24px;
      width: 600px;
      max-width: 90vw;
      transform: scale(0.9);
      transition: transform 200ms ease;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 24px 0;
      color: #111827;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 150ms ease, box-shadow 150ms ease;
    }

    .form-input:focus {
      border-color: #8B5CF6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }

    .form-hint {
      font-size: 12px;
      color: #6B7280;
      margin-top: 4px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 150ms ease;
    }

    .modal-btn-cancel {
      background: #ffffff;
      color: #374151;
      border: 1px solid #D1D5DB;
    }

    .modal-btn-cancel:hover {
      background: #F9FAFB;
    }

    .modal-btn-save {
      background: linear-gradient(90deg, #3B82F6, #2563EB);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .modal-btn-save:hover {
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    /* FINISH RAFFLE MODAL */
    .finish-modal-content {
      width: 540px;
    }

    .finish-modal-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #FF4FB2, #A855F7);
      border-radius: 50%;
      display: grid;
      place-items: center;
      margin: 0 auto 20px;
      font-size: 40px;
    }

    .finish-modal-text {
      font-size: 15px;
      color: #6B7280;
      margin-bottom: 28px;
      line-height: 1.6;
      text-align: center;
    }

    .winner-section {
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 28px;
    }

    .winner-section-title {
      font-size: 15px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .winner-form-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: white;
      cursor: pointer;
      transition: border-color 150ms ease, box-shadow 150ms ease;
    }

    .form-select:focus {
      border-color: #10B981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .finish-modal-actions {
      display: flex;
      gap: 12px;
    }

    .finish-btn {
      flex: 1;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 150ms ease;
    }

    .finish-btn-complete {
      background: linear-gradient(90deg, #10B981, #059669);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .finish-btn-complete:hover {
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
      transform: translateY(-1px);
    }

    .finish-btn-complete:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .finish-btn-cancel-raffle {
      background: linear-gradient(90deg, #EF4444, #DC2626);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .finish-btn-cancel-raffle:hover {
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
      transform: translateY(-1px);
    }

    .or-divider {
      text-align: center;
      color: #9CA3AF;
      font-size: 13px;
      font-weight: 600;
      margin: 16px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* TOAST NOTIFICATION */
    .toast {
      position: fixed;
      top: 30px;
      right: 30px;
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
      padding: 20px 28px;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(16, 185, 129, 0.5);
      font-size: 15px;
      font-weight: 600;
      z-index: 10000;
      min-width: 380px;
      max-width: 480px;
      opacity: 0;
      transform: translateX(400px);
      transition: opacity 400ms cubic-bezier(0.4, 0, 0.2, 1),
                  transform 400ms cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }

    .toast-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .toast-icon {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.25);
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .toast-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
    }

    .toast-body {
      margin-left: 44px;
      font-size: 13px;
      font-weight: 500;
      line-height: 1.6;
      opacity: 0.95;
    }

    .toast-detail {
      margin-top: 4px;
      color: rgba(255, 255, 255, 0.9);
    }

    .toast-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 24px;
      height: 24px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: background 150ms ease;
    }

    .toast-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Hidden rows */
    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div class="white-square">
    <div class="top-sidebar"></div>
    <div class="tako"></div>
    <div class="sidebar"></div>
    <div class="rectangle"></div>
    <div class="square" id="activeSquare"></div>

    <!-- SEARCH -->
    <div class="search-bar">
      <img src="/static/assets/Icons/Normal.png">
      <input placeholder="Search here...">
    </div>

    <div id="themeToggle" title="Theme Toggle">
      <img src="/static/assets/Icons/OFF.png" alt="Theme toggle">
    </div>
    <div id="settingsBtn" title="Settings">
      <img src="/static/assets/Icons/Notifications%20Copy.png" alt="Settings">
    </div>
    <div id="bellBtn" title="Notifications">
      <img class="bell-icon" src="/static/assets/Icons/bell.png" alt="Bell">
      <span class="blue-square"></span>
    </div>
    <div id="profileBtn" title="Profile">
      <img src="/static/assets/Icons/images-removebg-preview%201.png" alt="Profile">
    </div>

    <!-- STATS -->
    <section class="stats-row" aria-label="Active raffle overview">
      <div class="stat-card c-pink">
        <div class="stat-label">Total Spots</div>
        <div class="stat-value" id="totalSpots">-</div>
      </div>
      <div class="stat-card c-purple">
        <div class="stat-label">Spots Remaining</div>
        <div class="stat-value" id="spotsRemaining">-</div>
      </div>
      <div class="stat-card c-green">
        <div class="stat-label">Cost Per Spot</div>
        <div class="stat-value" id="costPerSpot">-</div>
      </div>
      <div class="stat-card c-orange">
        <div class="stat-label">Total Owed</div>
        <div class="stat-value" id="totalOwed">$0</div>
      </div>
      <div class="stat-card c-blue">
        <div class="stat-label">Total Paid</div>
        <div class="stat-value" id="totalPaid">$0</div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="participants-card">
      <div class="participants-header">
        <div>
          <h3 class="participants-title">Participants</h3>
          <div class="participants-sub"><span id="totalParticipants">0</span> total participants</div>
        </div>

        <div style="display:flex; gap:10px;">
          <button id="setupBtn" class="btn btn-blue">Setup</button>
          <button id="scanEmailBtn" class="btn btn-purple">Scan Email</button>
          <button id="markPaidBtn" class="btn btn-green">Mark All Paid</button>
          <button id="finishRaffleBtn" class="btn btn-red">Finish Raffle</button>
        </div>

        <div style="display:flex; gap:12px; align-items:center;">
          <div class="search-box">
            <input id="participantSearch" type="text" placeholder="Search participants..." />
          </div>

          <select id="paymentFilter" class="filter-select">
            <option value="all">All Payments</option>
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
          </select>
        </div>
      </div>

      <div class="table-wrap">
        <table class="p-table" id="participantsTable">
          <colgroup>
            <col class="col-reddit">
            <col class="col-name">
            <col class="col-comment">
            <col class="col-spots">
            <col class="col-owed">
            <col class="col-status">
          </colgroup>

          <thead>
            <tr>
              <th data-col="0"><div class="th-inner">Reddit User<span class="col-resizer"></span></div></th>
              <th data-col="1"><div class="th-inner">Name<span class="col-resizer"></span></div></th>
              <th data-col="2"><div class="th-inner">Comment<span class="col-resizer"></span></div></th>
              <th data-col="3"><div class="th-inner">Spots<span class="col-resizer"></span></div></th>
              <th data-col="4"><div class="th-inner">Owed<span class="col-resizer"></span></div></th>
              <th data-col="5"><div class="th-inner">Status<span class="col-resizer"></span></div></th>
            </tr>
          </thead>
          <tbody id="participantsTbody">
            <tr id="emptyRow">
              <td colspan="6" style="padding:26px 24px; text-align:center; color:#64748b;">
                No participants yet. Click "Setup" to configure your raffle.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="participants-foot">
        <div id="footerShowing">Showing 0 of 0 participants</div>
        <div id="footerStats">Paid: <strong>0</strong> &nbsp;&nbsp; Pending: <strong>0</strong></div>
      </div>
    </section>

    <!-- NAV -->
    <nav class="sidebar-nav" id="sidebarNav">
      <a class="nav-item" href="/dashboard"><img class="nav-icon" src="/static/assets/Icons/Heart-Rate.png" alt="">Dashboard</a>
      <a class="nav-item is-active" href="/active-raffle"><img class="nav-icon" src="/static/assets/Icons/Graph%20Copy.png" alt="">Active Raffle</a>
      <a class="nav-item" href="/raffle-history"><img class="nav-icon" src="/static/assets/Icons/Graph.png" alt="">Raffle History</a>
      <a class="nav-item" href="/profile"><img class="nav-icon" src="/static/assets/Icons/icons8-user-30%201.png" alt="">Profile</a>
      <a class="nav-item" href="#"><img class="nav-icon" src="/static/assets/Icons/discord_white_logo%201.png" alt="">Discord</a>
      <a class="nav-item" href="#"><img class="nav-icon" src="/static/assets/Icons/Graph%20Copy%204.png" alt="">Donate</a>
    </nav>
  </div>

  <!-- SETUP MODAL -->
  <div id="setupModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="modal-title">Raffle Setup</h3>

      <div class="modal-form">
        <div class="form-group">
          <label class="form-label">Reddit Link</label>
          <input
            type="url"
            id="redditLinkInput"
            class="form-input"
            placeholder="https://reddit.com/r/WatchURaffle/..."
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Total Spots</label>
            <input
              type="number"
              id="totalSpotsInput"
              class="form-input"
              placeholder="100"
              value="100"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Cost Per Spot ($)</label>
            <input
              type="number"
              id="spotCostInput"
              class="form-input"
              placeholder="50"
              value="50"
            />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Polling Interval (seconds)</label>
          <input
            type="number"
            id="pollingIntervalInput"
            class="form-input"
            placeholder="60"
            value="60"
          />
          <p class="form-hint">How often to check Reddit for new comments</p>
        </div>
      </div>

      <div class="modal-actions">
        <button id="modalCancelBtn" class="modal-btn modal-btn-cancel">Cancel</button>
        <button id="modalSaveBtn" class="modal-btn modal-btn-save">Save Setup</button>
      </div>
    </div>
  </div>

  <!-- FINISH RAFFLE MODAL -->
  <div id="finishModal" class="modal-overlay">
    <div class="modal-content finish-modal-content">
      <div class="finish-modal-icon">üéâ</div>
      <h3 class="modal-title" style="text-align: center;">Finish Raffle</h3>
      <p class="finish-modal-text">
        Select the winner to complete the raffle, or cancel it to save as incomplete.
      </p>

      <!-- Winner Selection Section -->
      <div class="winner-section">
        <div class="winner-section-title">
          <span>üèÜ</span>
          <span>Winner Information</span>
        </div>
        <div class="form-group" style="margin-bottom: 12px;">
          <label class="form-label">Select Winner</label>
          <select id="winnerSelect" class="form-select">
            <option value="">Choose a participant...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Winning Spot Number</label>
          <input
            type="number"
            id="winningSpotInput"
            class="form-input"
            placeholder="Enter spot number"
            min="1"
          />
        </div>
      </div>

      <div class="finish-modal-actions">
        <button id="finishCompleteBtn" class="finish-btn finish-btn-complete" disabled>
          ‚úì Complete Raffle
        </button>
      </div>

      <div class="or-divider">or</div>

      <button id="finishCancelBtn" class="finish-btn finish-btn-cancel-raffle" style="width: 100%;">
        √ó Cancel Raffle
      </button>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->
  <div id="successToast" class="toast">
    <button class="toast-close" id="toastClose">√ó</button>
    <div class="toast-header">
      <div class="toast-icon">‚úì</div>
      <h4 class="toast-title" id="toastTitle">Success!</h4>
    </div>
    <div class="toast-body">
      <div id="toastMessage"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY_ACTIVE = 'active_raffle_state';

    // ============ APP STATE ============
    const appState = {
      redditLink: '',
      totalSpots: null,
      costPerSpot: null,
      pollingInterval: 60,
      participants: []
    };

    // ============ PERSISTENCE FUNCTIONS ============
    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY_ACTIVE, JSON.stringify(appState));
      } catch (e) {
        console.error('Failed to save state:', e);
      }
    }

    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY_ACTIVE);
        if (saved) {
          const data = JSON.parse(saved);
          appState.redditLink = data.redditLink || '';
          appState.totalSpots = data.totalSpots;
          appState.costPerSpot = data.costPerSpot;
          appState.pollingInterval = data.pollingInterval || 60;
          appState.participants = data.participants || [];

          // Update modal inputs
          document.getElementById("redditLinkInput").value = appState.redditLink;
          document.getElementById("totalSpotsInput").value = appState.totalSpots || 100;
          document.getElementById("spotCostInput").value = appState.costPerSpot || 50;
          document.getElementById("pollingIntervalInput").value = appState.pollingInterval;

          // Rebuild table if there are participants
          if (appState.participants.length > 0) {
            rebuildTable();
          }
        }
      } catch (e) {
        console.error('Failed to load state:', e);
      }
    }

    function clearState() {
      try {
        localStorage.removeItem(STORAGE_KEY_ACTIVE);
      } catch (e) {
        console.error('Failed to clear state:', e);
      }
    }

    function rebuildTable() {
      const tbody = document.getElementById("participantsTbody");
      const emptyRow = document.getElementById("emptyRow");

      if (appState.participants.length === 0) {
        if (!emptyRow) {
          tbody.innerHTML = '<tr id="emptyRow"><td colspan="6" style="padding:26px 24px; text-align:center; color:#64748b;">No participants yet. Click "Setup" to configure your raffle.</td></tr>';
        }
        return;
      }

      if (emptyRow) {
        emptyRow.remove();
      }

      tbody.innerHTML = '';

      appState.participants.forEach(participant => {
        const row = document.createElement('tr');
        row.dataset.reddit = participant.redditUser;
        row.dataset.name = participant.name;
        row.dataset.comment = participant.comment;
        row.dataset.paid = participant.paid;

        const initial = participant.redditUser.charAt(2).toUpperCase();
        const statusClass = participant.paid ? 'status-paid' : 'status-pending';
        const statusIcon = participant.paid ? '‚úì' : '‚è±';
        const statusText = participant.paid ? 'Paid' : 'Pending';

        row.innerHTML = `
          <td>
            <div class="user-cell">
              <div class="avatar">${initial}</div>
              <a class="reddit-link" href="#" onclick="return false;">${participant.redditUser}</a>
            </div>
          </td>
          <td>${participant.name}</td>
          <td><span class="comment-muted">${participant.comment || ''}</span></td>
          <td><span class="spots-pill">${participant.spots}</span></td>
          <td>$${participant.owed}</td>
          <td><span class="status-chip ${statusClass}"><span class="dot">${statusIcon}</span>${statusText}</span></td>
        `;

        tbody.appendChild(row);
      });
    }

    // ============ UTILITY FUNCTIONS ============
    function showToast(title, details) {
      const toast = document.getElementById("successToast");
      const toastTitle = document.getElementById("toastTitle");
      const toastMessage = document.getElementById("toastMessage");

      toastTitle.textContent = title;
      toastMessage.innerHTML = details.map(d => `<div class="toast-detail">${d}</div>`).join('');

      toast.classList.add("show");

      setTimeout(() => {
        toast.classList.remove("show");
      }, 4000);
    }

    function updateStats() {
      const totalSpotsEl = document.getElementById("totalSpots");
      const spotsRemainingEl = document.getElementById("spotsRemaining");
      const costPerSpotEl = document.getElementById("costPerSpot");
      const totalOwedEl = document.getElementById("totalOwed");
      const totalPaidEl = document.getElementById("totalPaid");

      totalSpotsEl.textContent = appState.totalSpots !== null ? appState.totalSpots : '-';
      costPerSpotEl.textContent = appState.costPerSpot !== null ? `$${appState.costPerSpot}` : '-';

      const spotsClaimed = appState.participants.reduce((sum, p) => sum + (p.spots || 0), 0);
      const spotsRemaining = appState.totalSpots !== null ? appState.totalSpots - spotsClaimed : '-';
      spotsRemainingEl.textContent = spotsRemaining;

      const totalOwed = appState.participants.reduce((sum, p) => sum + (p.owed || 0), 0);
      const totalPaid = appState.participants.filter(p => p.paid).reduce((sum, p) => sum + (p.owed || 0), 0);

      totalOwedEl.textContent = `$${totalOwed.toLocaleString()}`;
      totalPaidEl.textContent = `$${totalPaid.toLocaleString()}`;
    }

    function updateFooter() {
      const tbody = document.getElementById("participantsTbody");
      const visibleRows = Array.from(tbody.querySelectorAll("tr:not(.hidden):not(#emptyRow)"));
      const totalCount = appState.participants.length;
      const visibleCount = visibleRows.length;

      const paidCount = appState.participants.filter(p => p.paid).length;
      const pendingCount = totalCount - paidCount;

      document.getElementById("footerShowing").textContent = `Showing ${visibleCount} of ${totalCount} participants`;
      document.getElementById("footerStats").innerHTML = `Paid: <strong>${paidCount}</strong> &nbsp;&nbsp; Pending: <strong>${pendingCount}</strong>`;
      document.getElementById("totalParticipants").textContent = totalCount;
    }

    function filterAndSearch() {
      const searchQuery = document.getElementById("participantSearch").value.toLowerCase();
      const paymentFilter = document.getElementById("paymentFilter").value;
      const tbody = document.getElementById("participantsTbody");
      const rows = Array.from(tbody.querySelectorAll("tr:not(#emptyRow)"));

      rows.forEach(row => {
        const redditUser = row.dataset.reddit?.toLowerCase() || '';
        const name = row.dataset.name?.toLowerCase() || '';
        const comment = row.dataset.comment?.toLowerCase() || '';
        const paid = row.dataset.paid === 'true';

        const matchesSearch = redditUser.includes(searchQuery) ||
                            name.includes(searchQuery) ||
                            comment.includes(searchQuery);
        const matchesFilter = paymentFilter === 'all' ||
                             (paymentFilter === 'paid' && paid) ||
                             (paymentFilter === 'pending' && !paid);

        if (matchesSearch && matchesFilter) {
          row.classList.remove('hidden');
        } else {
          row.classList.add('hidden');
        }
      });

      updateFooter();
    }

    function saveToHistory(status, winner = null) {
      const historyEntry = {
        id: Date.now(),
        date: new Date().toISOString(),
        status: status,
        redditLink: appState.redditLink,
        totalSpots: appState.totalSpots,
        costPerSpot: appState.costPerSpot,
        participants: appState.participants,
        totalOwed: appState.participants.reduce((sum, p) => sum + (p.owed || 0), 0),
        totalPaid: appState.participants.filter(p => p.paid).reduce((sum, p) => sum + (p.owed || 0), 0),
        winner: winner
      };

      try {
        const history = JSON.parse(localStorage.getItem('raffle_history') || '[]');
        history.unshift(historyEntry);
        localStorage.setItem('raffle_history', JSON.stringify(history));
      } catch (e) {
        console.error('Failed to save to history:', e);
      }
    }

    function resetRaffle() {
      appState.redditLink = '';
      appState.totalSpots = null;
      appState.costPerSpot = null;
      appState.pollingInterval = 60;
      appState.participants = [];

      clearState();

      const tbody = document.getElementById("participantsTbody");
      tbody.innerHTML = '<tr id="emptyRow"><td colspan="6" style="padding:26px 24px; text-align:center; color:#64748b;">No participants yet. Click "Setup" to configure your raffle.</td></tr>';

      document.getElementById("redditLinkInput").value = '';
      document.getElementById("totalSpotsInput").value = '100';
      document.getElementById("spotCostInput").value = '50';
      document.getElementById("pollingIntervalInput").value = '60';
      document.getElementById("participantSearch").value = '';
      document.getElementById("paymentFilter").value = 'all';

      updateStats();
      updateFooter();
    }

    function populateWinnerDropdown() {
      const winnerSelect = document.getElementById("winnerSelect");
      const paidParticipants = appState.participants.filter(p => p.paid);

      // Clear existing options except first
      winnerSelect.innerHTML = '<option value="">Choose a participant...</option>';

      if (paidParticipants.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No paid participants';
        option.disabled = true;
        winnerSelect.appendChild(option);
        return;
      }

      paidParticipants.forEach(participant => {
        const option = document.createElement('option');
        option.value = participant.redditUser;
        option.textContent = `${participant.redditUser} - ${participant.name}`;
        winnerSelect.appendChild(option);
      });
    }

    // ============ SIDEBAR NAVIGATION ============
    (function () {
      const nav = document.getElementById("sidebarNav");
      const square = document.getElementById("activeSquare");
      function moveSquareTo(item) {
        const navRect = nav.getBoundingClientRect();
        const itemRect = item.getBoundingClientRect();
        const navTop = parseFloat(getComputedStyle(nav).top) || 0;
        square.style.top = navTop + (itemRect.top - navRect.top) + "px";
      }
      const active = nav.querySelector(".is-active");
      if (active) moveSquareTo(active);
    })();

    // ============ COLUMN RESIZE ============
    (function () {
      const table = document.getElementById("participantsTable");
      if (!table) return;

      const STORAGE_KEY = "raffleui_participants_colwidths_v1";
      const colgroup = table.querySelector("colgroup");
      const cols = Array.from(colgroup.querySelectorAll("col"));
      const ths = Array.from(table.querySelectorAll("thead th"));

      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
        if (saved && Array.isArray(saved) && saved.length === cols.length) {
          saved.forEach((w, i) => {
            if (typeof w === "number" && w > 40) cols[i].style.width = Math.round(w) + "px";
          });
        }
      } catch (_) {}

      let isDragging = false;
      let startX = 0;
      let startWidth = 0;
      let colIndex = -1;

      function onMove(e) {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const dx = clientX - startX;
        const minW = 70;
        const newW = Math.max(minW, startWidth + dx);
        cols[colIndex].style.width = Math.round(newW) + "px";
        document.documentElement.classList.add("resizing");
      }

      function saveWidths() {
        const widths = cols.map(c => Math.round(parseFloat(getComputedStyle(c).width) || 0));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(widths));
      }

      function onUp() {
        if (!isDragging) return;
        isDragging = false;
        colIndex = -1;
        document.documentElement.classList.remove("resizing");
        saveWidths();
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", onUp);
        window.removeEventListener("touchmove", onMove, { passive:false });
        window.removeEventListener("touchend", onUp);
      }

      ths.forEach((th) => {
        const handle = th.querySelector(".col-resizer");
        if (!handle) return;

        handle.addEventListener("mousedown", (e) => {
          e.preventDefault();
          const idx = parseInt(th.dataset.col, 10);
          if (!Number.isFinite(idx)) return;

          isDragging = true;
          colIndex = idx;
          startX = e.clientX;
          startWidth = parseFloat(getComputedStyle(cols[idx]).width) || cols[idx].getBoundingClientRect().width;

          window.addEventListener("mousemove", onMove);
          window.addEventListener("mouseup", onUp);
        });

        handle.addEventListener("touchstart", (e) => {
          e.preventDefault();
          const idx = parseInt(th.dataset.col, 10);
          if (!Number.isFinite(idx)) return;

          isDragging = true;
          colIndex = idx;
          startX = e.touches[0].clientX;
          startWidth = parseFloat(getComputedStyle(cols[idx]).width) || cols[idx].getBoundingClientRect().width;

          window.addEventListener("touchmove", onMove, { passive:false });
          window.addEventListener("touchend", onUp);
        }, { passive:false });
      });
    })();

    // ============ SETTINGS BUTTON ============
    document.getElementById("settingsBtn").addEventListener("click", () => {
      window.location.href = "/settings";
    });

    // ============ SETUP MODAL ============
    (function () {
      const setupBtn = document.getElementById("setupBtn");
      const modal = document.getElementById("setupModal");
      const cancelBtn = document.getElementById("modalCancelBtn");
      const saveBtn = document.getElementById("modalSaveBtn");

      const redditLinkInput = document.getElementById("redditLinkInput");
      const totalSpotsInput = document.getElementById("totalSpotsInput");
      const spotCostInput = document.getElementById("spotCostInput");
      const pollingIntervalInput = document.getElementById("pollingIntervalInput");

      setupBtn.addEventListener("click", () => {
        modal.classList.add("show");
      });

      function closeModal() {
        modal.classList.remove("show");
      }

      cancelBtn.addEventListener("click", closeModal);

      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      saveBtn.addEventListener("click", () => {
        const data = {
          redditLink: redditLinkInput.value,
          totalSpots: parseInt(totalSpotsInput.value) || 100,
          spotCost: parseInt(spotCostInput.value) || 50,
          pollingInterval: parseInt(pollingIntervalInput.value) || 60
        };

        appState.redditLink = data.redditLink;
        appState.totalSpots = data.totalSpots;
        appState.costPerSpot = data.spotCost;
        appState.pollingInterval = data.pollingInterval;

        saveState();
        updateStats();

        const details = [];
        if (data.redditLink) {
          details.push('üìù Reddit post linked');
        }
        details.push(`üéØ ${data.totalSpots} spots @ $${data.spotCost} each`);
        details.push(`‚è±Ô∏è Polling every ${data.pollingInterval}s`);

        showToast('Setup Saved Successfully!', details);
        closeModal();
      });
    })();

    // ============ FINISH RAFFLE MODAL ============
    (function () {
      const finishBtn = document.getElementById("finishRaffleBtn");
      const modal = document.getElementById("finishModal");
      const completeBtn = document.getElementById("finishCompleteBtn");
      const cancelBtn = document.getElementById("finishCancelBtn");
      const winnerSelect = document.getElementById("winnerSelect");
      const winningSpotInput = document.getElementById("winningSpotInput");

      finishBtn.addEventListener("click", () => {
        populateWinnerDropdown();
        winnerSelect.value = '';
        winningSpotInput.value = '';
        completeBtn.disabled = true;
        modal.classList.add("show");
      });

      function closeModal() {
        modal.classList.remove("show");
      }

      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      // Enable/disable complete button based on winner selection
      function validateWinnerSelection() {
        const hasWinner = winnerSelect.value !== '';
        const hasSpot = winningSpotInput.value !== '' && parseInt(winningSpotInput.value) > 0;
        completeBtn.disabled = !(hasWinner && hasSpot);
      }

      winnerSelect.addEventListener("change", validateWinnerSelection);
      winningSpotInput.addEventListener("input", validateWinnerSelection);

      completeBtn.addEventListener("click", () => {
        const winnerUsername = winnerSelect.value;
        const winningSpot = parseInt(winningSpotInput.value);

        if (!winnerUsername || !winningSpot) {
          alert('Please select a winner and enter a winning spot number.');
          return;
        }

        if (winningSpot < 1 || winningSpot > appState.totalSpots) {
          alert(`Winning spot must be between 1 and ${appState.totalSpots}.`);
          return;
        }

        const winner = {
          username: winnerUsername,
          spot: winningSpot
        };

        saveToHistory('completed', winner);

        const details = [
          `üèÜ Winner: ${winnerUsername}`,
          `üéØ Winning Spot: #${winningSpot}`,
          'üìÅ Saved to Raffle History',
          'üîÑ Ready for new raffle'
        ];

        showToast('Raffle Completed!', details);
        closeModal();

        setTimeout(() => {
          resetRaffle();
        }, 500);
      });

      cancelBtn.addEventListener("click", () => {
        saveToHistory('cancelled', null);

        const details = [
          '‚ùå Raffle cancelled',
          'üìÅ Saved to Raffle History',
          'üîÑ Ready for new raffle'
        ];

        showToast('Raffle Cancelled', details);
        closeModal();

        setTimeout(() => {
          resetRaffle();
        }, 500);
      });
    })();

    // ============ SCAN EMAIL BUTTON ============
    document.getElementById("scanEmailBtn").addEventListener("click", () => {
      const details = [
        'üìß Gmail inbox scanned',
        '‚úÖ Payment confirmations detected',
        'üîÑ Participant statuses updated'
      ];
      showToast('Email Scan Complete!', details);
    });

    // ============ MARK ALL PAID BUTTON ============
    document.getElementById("markPaidBtn").addEventListener("click", () => {
      const pendingCount = appState.participants.filter(p => !p.paid).length;
      const totalAmount = appState.participants.reduce((sum, p) => sum + (p.owed || 0), 0);

      const details = [
        `‚úì ${pendingCount} participants marked as paid`,
        `üí∞ Total confirmed: $${totalAmount.toLocaleString()}`,
        'üéâ All payments complete!'
      ];
      showToast('Payments Updated!', details);

      appState.participants.forEach(p => p.paid = true);
      saveState();
      rebuildTable();
      updateStats();
      updateFooter();
    });

    // ============ SEARCH & FILTER ============
    document.getElementById("participantSearch").addEventListener("input", filterAndSearch);
    document.getElementById("paymentFilter").addEventListener("change", filterAndSearch);

    // ============ TOAST CLOSE ============
    document.getElementById("toastClose").addEventListener("click", () => {
      document.getElementById("successToast").classList.remove("show");
    });

    // ============ INITIALIZE ============
    loadState();
    updateStats();
    updateFooter();
  </script>
</body>
</html>
